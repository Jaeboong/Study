# 목차

1. DHCP IP 할당 방식
2. 동작 절차
3. DHCP 패킷

# DHCP의 IP 할당 방식

DHCP는 처음 부팅한 컴퓨터나, 디스크가 없는 컴퓨터에게 4가지 정보를 제공하기 위해 설계된 프로토콜

- 컴퓨터 IP주소
- 컴퓨터 해당 서브 넷 마스크
- 라우터 IP 주소
- 네임서버 IP 주소

### 이전 프로토콜

- RARP -> IP주소만 제공
- BOOTP -> 위 4가지 항목 모두 제공 but 동적 할당안됨


## 동작절차 (동일망)

![image](https://github.com/Jaeboong/Study/assets/158824294/bcab4f9d-053a-4101-9154-26d14b626d84)

DHCP 서버는 UDP 포트 67에 수동 열기 명령을 수행하고 클라이언트로부터 요청을 기다림

부팅된 클라이언트는 포트번호 68에 능동 열기 명령을 수행함

이 메세지는 목적지 포트 67, 발신지 포트 68을 가지는 UDP 사용자 데이터그램으로 캡슐화

그 후 이 데이터 그램은 IP 데이터그램으로 캡슐화

### 자신의 IP주소도 몰라, 서버의 IP 주소도 몰라...

발신지 주소는 모두 0 (0.0.0.0)

목적지 주소는 모두 1로 지정 (255.255.255.255)

------------------

서버는 UDP 목적지 포트 번호를 반대로 68, 발신지 포트번호는 67 지정!

유니캐스트 or 브로드캐스트로 클라이언트에게 전송~

```
응답이 유니캐스트가 될 수 있다 -> 서버가 클라이언트의 IP 주소를 알기 때문
```

## 서로 다른 망

![image](https://github.com/Jaeboong/Study/assets/158824294/aa8a3186-55a9-4ee7-826f-947c29e0d0b2)


서로 다른 망에 있을 때는 동일 망 처럼 했을 때 한가지 문제점이 발생함

클라이언트가 보내는 브로드캐스트 된 IP 데이터그램은 모두 1로 채워져있기 때문에 그 어떤 라우터도 통과하지 못함...

그래서 이 문제를 해결할 에이전트가 탄생

# Relay Agent ( 중계 에이젼트)

호스트 중 하나 or 응용 계층에서 동작할 수 있는 라우터가 이 중계 에이전트가 사용됨

중계 에이전트는 서버의 유니캐스트 주소를 알고있음!

포트번호 67로부터 들어오는 브로드캐스트 메세지를 기다리다 패킷을 수신하면 유니캐스트 메세지에 캡슐화하여 DHCP 서버로 전송!

DHCP 서버는 중계 에이전트의 IP 주소를 요청 메세지에 있는 필드 중 하나에 IP 주소를 정의하고 있기 때문에 중계 에이전트로부터 온 메세지임을 알고있음

# 잠깐 포트타임~

포트를 아까 67, 68을 사용했는데 이게 뭐냐?

이것은 잘 알려진 포트이다. Well-known-ports 라고 하는데 인터넷 표준화 기구인 IANA에서 특정 서비스를 위해 약속한 포트번호랍니다.

# DHCP 패킷

![image](https://github.com/Jaeboong/Study/assets/158824294/aedbd7bd-ddc0-484c-b366-5366d14c4e50)

- Number of Seconds: 클라이언트 부팅 된 후 경과 시간
- Flag: 16비트 값을 가지고 맨 왼쪽 비트만 사용되고 나머지 비트들은 0으로 설정, 맨 왼쪽 비트는 서버로 부터의 응답이 유니캐스트가 아니라 강제적으로 브로드캐스트 응답이어야 함을 명시
      -> 만약 브로드캐스트가 아니라 유니캐스트라면?
        -> 클라이언트는 그게 본인에게 보내는 것인지 모르므로 패킷을 버린다.
  ![image](https://github.com/Jaeboong/Study/assets/158824294/b5f23efc-df8c-4861-9c61-de35e817d6b7)
- 클라이언트 IP 주소: 클라이언트 IP주소를 저장하고, 클라이언트가 이 정보를 가지고있지 않다면 모두 0으로 지정
- 상대방 IP 주소: 클라이언트 IP 주소를 포함, 서버는 이 값을 응답 메세지에 기록 (서버가 클라이언트에게 제공하는 IP주소)
- 서버 IP 주소: 서버의 IP 주소, 이 값을 응답 메세지에 기록
- 게이트웨이 IP 주소: 라우터의 IP 주소
- 클라이언트 하드웨어 주소: 클라이언트의 물리 주소
- 서버이름: ㅈㄱㄴ, 도메인
- 부트 파일 이름: 부트파일 전체 경로명을 포함





